---
title: "location table - feather river redd data"
date: "2024-12-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(dplyr)
library(readxl)
library(leaflet)
library(purrr)
library(stringr)
```

The purpose of this markdown is to analyze redd data and understand when redds were not observed. A new reference table will be created

```{r}
redd_observations <- read_csv("data/redd_observations_wnames.csv")
```


```{r}
redd_observations |> 
  mutate(week = week(date),
         year = year(date)) |> 
  ggplot(aes(x = week, y = number_redds)) +
  geom_point() +
  facet_wrap(~year)
```


### Data exploration by year - the goal is to compare to Chris documntation

Summarizing by date and survey location 

```{r}
# summary <- redd_observations |> 
#   group_by(location, date) |> 
#   summarize(number_redds) |> 
#   glimpse()
# 
# redd_summary_by_date <- redd_observations |> 
#   group_by(location, date) |> 
#   summarize(total_redds = sum(number_redds, na.rm = TRUE), .groups = "drop") |> 
#   complete(location, date, fill = list(total_redds = 0)) # adding 0 to those days/locations that dont have redds 
# 
# redd_observations <- redd_observations |> 
#   mutate(year = year(date), week = week(date))
# 
# redd_summary_by_year_week <- redd_observations |> 
#   group_by(location, year, week) |> 
#   summarize(total_redds = sum(number_redds, na.rm = TRUE), .groups = "drop") |> 
#   complete(location, year, week, fill = list(total_redds = 0)) 
# 
# list(by_date = redd_summary_by_date,
#      by_year_week = redd_summary_by_year_week)
```

```{r}
 redd_observations  |> 
  mutate(year = year(date)) |> 
  distinct(location, year) |> 
  count(location, year) |> 
  ggplot(aes(x = year, y = location, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "blue", na.value = "white") +
  scale_x_continuous(breaks = seq(min(redd_observations$date, na.rm = TRUE) |> year(),
                                  max(redd_observations$date, na.rm = TRUE) |>  year(),
                                  by = 1),
                     expand = c(0, 0)) +
  labs(title = "Surveyed Locations Across Years",
       x = "Year",
       y = "Location",
       fill = "Survey Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 35, hjust = 1),
        axis.text.y = element_text(angle = 25, size = 7))
```

```{r, include=FALSE}
survey_data_week <- redd_observations  |>
  mutate(year = year(date),
         week = week(date)) |>
  distinct(location, year, week)

survey_data_week |>
ggplot(aes(x = year, y = as.factor(week))) +
  geom_tile(aes(fill = location), color = "white") +
  labs(
    title = "Surveyed Sites per Year and Week Number",
    x = "Year",
    y = "Week Number",
    fill = "Location"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text.y = element_text(size = 8))
```

A new table will be created with: date, survey_group, survey_location, is_redd_observed. Survey_group will be created categorizing locations by: Hwy 162-outlet, HFC, upstream of Hwy 70 (GSA adjacent areas)

```{r, include=FALSE}
# defining categories - would need to complete this if we want to add survey_group
# upstream_hwy_70 <- c("TableMountain", "LowerTableMountain", "HatcheryPipe", "UpperCottonwood", "UpperHatchery", "Hatchery", "Cottonwood", "TopofAuditorium", "MoesSideChannel", "UpperAuditorium", "HatcherySideChannel", "LowerAuditorium", "BelowLowerAuditorium", "Bedrock",  "MiddleAuditorium") |> tolower()
# 
# hwy_162_outlet <- c("TrailerPark", "UpperMathews", "Mathews", "Aleck", "UpperRobinson", "LowerRobinson", "SteepSideChannel", "Steep", "Weir", "EyeSideChannel", "Eye", "Gateway") |> tolower()
# 
# hfc <- redd_observations |>
#   mutate(location = tolower(location)) |>
#   filter(!(location %in% upstream_hwy_70) & !(location %in% hwy_162_outlet)) |>
#   distinct(location) |>
#   # filter(!location %in% c("g95main", "lowervanceeast", "greatwestern", "topofhatchery", "palm")) |>
#   pull(location)
```

```{r}
# adding a new column with survey group
# redd_observations_groups <- redd_observations |>
#   mutate(location = tolower(location),
#          survey_group = case_when(
#            location %in% upstream_hwy_70 ~ "upstream_hwy_70",
#            location %in% hwy_162_outlet ~ "hwy_162_outlet",
#            # location %in% c("g95main", "lowervanceeast", "greatwestern", "topofhatchery", "palm") ~ "excluded_sites",
#            TRUE ~ "other" )) |>
#   glimpse()
```


## Exploring data by year to compare to documentation

### 2014

```{r, echo=FALSE}
week_start_2014 <- ymd("2014-09-09") # survey started Sept 9

survey_data_2014 <- redd_observations |>
  filter(year(date) == 2014) |>
  # mutate(custom_week = as.integer(difftime(date, week_start_2014, units = "weeks")) + 1) |>
  # distinct(location, custom_week) |>
  glimpse()

ggplot(survey_data_2014, aes(x = location, y = as.factor(custom_week))) +
  geom_tile(color = "white") +
  labs(title = "Surveyed Sites in 2014 by Week Number",
       x = "Survey Location",
       y = "Week Number") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.text.y = element_text(size = 8))
```

TODO and note, some years have different number of weeks than what is mentioned on documentation (2023-10 weeks, 2019-12 weeks, 2018-9 weeks, 2015-13 weeks, 2014-9 weeks)

```{r}
#TODO note that it seems like some weeks were not surveyed at all. This means that even though we number the weeks starting with the first survey event, the survey week count is different. We might need to do the numbering manually?
# since every survey started at a different date, it will we defined here
# week_start_dates <- tibble(year = 2014:2023,
#                            week_start = c("2014-09-09", "2015-09-16", "2016-09-20", "2017-10-03", "2018-09-28", "2019-09-16",
#                                           "2020-09-22", "2021-09-16", "2022-09-14", "2023-09-18") |> 
#                              ymd())
# # function to plot each year like above
# plot_year_data <- function(year, week_start) {
#   survey_data <- redd_observations |> 
#     filter(year(date) == year) |> 
#     mutate(custom_week = as.integer(difftime(date, week_start, units = "weeks")) + 1) |> 
#     distinct(location, custom_week)
#   
# ggplot(survey_data, aes(x = location, y = as.factor(custom_week))) +
#   geom_tile(fill = "steelblue", color = "white") +
#   labs(title = paste("Surveyed Sites in", year, "by Week Number"),
#        x = "Survey Location",
#        y = "Week Number") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
#         axis.text.y = element_text(size = 8))
# }
# 
# walk2(week_start_dates$year, week_start_dates$week_start, ~ print(plot_year_data(.x, .y)))

```
```{r, include=FALSE}
# filtering by year to clean weeks
redd_2023 <- redd_observations |> 
  filter(year(date) == 2023) 

redd_2022 <- redd_observations |> 
  filter(year(date) == 2022) 

redd_2021 <- redd_observations |> 
  filter(year(date) == 2021) 

redd_2020 <- redd_observations |> 
  filter(year(date) == 2020)

redd_2019 <- redd_observations |> 
  filter(year(date) == 2019) 

redd_2018 <- redd_observations |> 
  filter(year(date) == 2018) 

redd_2017 <- redd_observations |> 
  filter(year(date) == 2017) 

redd_2016 <- redd_observations |> 
  filter(year(date) == 2016) 

redd_2015 <- redd_observations |> 
  filter(year(date) == 2015) 

redd_2014 <- redd_observations |> 
  filter(year(date) == 2014) 
```


Transform survey week

## 2023

```{r}
unique(redd_2023$survey_wk)
sum(is.na(redd_2023$survey_wk)) #1420 NA values

redd_2023_clean <- redd_2023 |> 
  mutate(survey_wk = as.character(sub("-.*", "", survey_wk)))

unique(redd_2023_clean$survey_wk) # week 10 is skipped, this is consistent with documentation. Maybe change week 11 to 10?
sum(is.na(redd_2023_clean$survey_wk))
```


## 2022 

```{r}
unique(redd_2022$survey_wk)

sum(is.na(redd_2022$survey_wk))

redd_2022 |> filter(survey_wk == "1-Apr") |> view()

redd_2022_clean <- redd_2022 |> 
   mutate(
    survey_wk = case_when(
      survey_wk == "1-Apr" ~ "4",  # These date corresponds to records that have week == 4
      TRUE ~ str_extract(survey_wk, "^[0-9]+")))

unique(redd_2022_clean$survey_wk)

sum(is.na(redd_2022_clean$survey_wk)) # check for NA values
```

## 2021

```{r}
unique(redd_2021$survey_wk)
sum(is.na(redd_2021$survey_wk))

redd_2021_clean <- redd_2021 |> 
   mutate(survey_wk = as.character(sub("-.*", "", survey_wk)))

unique(redd_2021_clean$survey_wk)
sum(is.na(redd_2021_clean$survey_wk)) # check for NA values
```

## 2020

```{r}
unique(redd_2020$survey_wk)
sum(is.na(redd_2020$survey_wk))

redd_2020_clean <- redd_2020 |> 
    mutate(
    survey_wk = case_when(
      survey_wk == "5-Mar" ~ "3", # this date corresponds to week 3 - 2020-10-09 - Check all these changes
      survey_wk == "4-May" ~ "5", # this date corresponds to week 5 - 2020-10-22
      survey_wk == "3-Aug" ~ "8", # this date corresponds to week 8 - 2020-11-12
      TRUE ~ str_extract(survey_wk, "^[0-9]+")  
    )
  )

unique(redd_2020_clean$survey_wk)
sum(is.na(redd_2020_clean$survey_wk))
```

## 2019

```{r}
# note that the range of these survey weeks is 3 - 12. We should ask what happened to week 1 and 2
unique(redd_2019$survey_wk)
sum(is.na(redd_2019$survey_wk))

redd_2019_clean <- redd_2019 |> 
    mutate(
    survey_wk = case_when(
      survey_wk == "2-Jun" ~ "6", # this date corresponds to week 6	- 2019-10-08
      survey_wk == "5-Jun" ~ "6", # this date corresponds to week 6 - 2019-10-11
      survey_wk == "3-Jul" ~ "7", # this date corresponds to week 7 - 2019-10-16
      survey_wk == "1-Nov" ~ "11", # this date corresponds to week 11 - 2019-11-12
      TRUE ~ str_extract(survey_wk, "^[0-9]+")  
    )
  )

unique(redd_2019_clean$survey_wk)
sum(is.na(redd_2019_clean$survey_wk))
```

## 2018

```{r}
unique(redd_2018$survey_wk)
sum(is.na(redd_2018$survey_wk))

redd_2018_clean <- redd_2018 |> 
    mutate(
    survey_wk = case_when(
      survey_wk == "2-Mar" ~ "3", # this date corresponds to week 3 - 2018-10-02
      survey_wk == "1-May" ~ NA, # 1-May weeks have 2018-10-02 date. No data entries have survey_wk recorded. Setting these to NA for now
      TRUE ~ str_extract(survey_wk, "^[0-9]+")  
    )
  )

unique(redd_2018_clean$survey_wk)
sum(is.na(redd_2018_clean$survey_wk)) # 5 NA values from 1-May
```

## 2017

```{r}
unique(redd_2017$survey_wk)
sum(is.na(redd_2017$survey_wk))

redd_2017_clean <- redd_2017 |> 
    mutate(survey_wk = str_extract(survey_wk, "[0-9]+"))

unique(redd_2017_clean$survey_wk)
sum(is.na(redd_2017_clean$survey_wk))
```

## 2016

```{r}
unique(redd_2016$survey_wk)
sum(is.na(redd_2016$survey_wk))

redd_2016_clean <- redd_2016 |> 
    mutate(survey_wk = str_extract(survey_wk, "[0-9]+"))

unique(redd_2016_clean$survey_wk)
sum(is.na(redd_2016_clean$survey_wk))
```

## 2015

```{r}
unique(redd_2015$survey_wk)
sum(is.na(redd_2015$survey_wk))

redd_2015_clean <- redd_2015 |> 
    mutate(
    survey_wk = case_when(
      survey_wk == "2-Jan" ~ "1", # 2015-09-17
      survey_wk == "1-Feb" ~ "2", # 2015-09-21
      survey_wk == "3-Feb" ~ "2", # 2015-09-24 
      survey_wk == "1-Mar" ~ "3", # 2015-09-28
      survey_wk == "2-May" ~ "5", #	2015-10-15
      survey_wk == "3-May" ~ "5", # date: 2015-10-16
      survey_wk == "HFWK1" ~ "5", # date: 2015-10-16
      survey_wk == "2-Jun" ~ "6", # 2015-10-20
      survey_wk == "2-Sep" ~ "9", # 2015-11-11
      survey_wk == "2-Oct" ~ "10", # 2015-11-19
      TRUE ~ str_extract(survey_wk, "[0-9]+")))

unique(redd_2015_clean$survey_wk)
sum(is.na(redd_2015_clean$survey_wk))
```

## 2014

```{r}
unique(redd_2014$survey_wk)
sum(is.na(redd_2014$survey_wk))

redd_2014_clean <- redd_2014 |> 
    mutate(
    survey_wk = case_when(
      survey_wk == "1-Jan" ~ "1", # 2014-09-09
      survey_wk == "2-Mar" ~ "3", # 2014-09-25
      survey_wk == "2-Apr" ~ "4", # 2014-10-01  
      survey_wk == "1-May" ~ "5", # 2014-10-06
      survey_wk == "1-Jun" ~ "6", # 2014-10-14	
      survey_wk == "2-Jun" ~ "6", # 2014-10-17
      survey_wk == "1-Aug" ~ "8", #2 014-11-12
      survey_wk == "HF2" ~ NA, # date of 2014-11-07 all survey_wk of HF2. No data entries have actual survey_wk recorded. Setting these to NA for now
      survey_wk == "HF" ~ NA, # date of 2014-10-09 all survey_wk of HF. No data entries have actual survey_wk recorded. Setting these to NA for now
      TRUE ~ str_extract(survey_wk, "[0-9]+")))

unique(redd_2014_clean$survey_wk)
sum(is.na(redd_2014_clean$survey_wk)) # the 46 values that are HF2 and HF
```

Combine all years

```{r}
clean_redd <- bind_rows(redd_2014_clean, redd_2015_clean, redd_2016_clean, redd_2017_clean, redd_2018_clean, redd_2019_clean, redd_2020_clean, redd_2021_clean, redd_2022_clean, redd_2023_clean)


sum(is.na(clean_redd$survey_wk)) # most NA values are from 2023 when no survey_wk data was added 

```



