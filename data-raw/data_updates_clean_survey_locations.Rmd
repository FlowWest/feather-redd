---
title: "feather river redd survey locations naming qc - adding names to data"
date: "2024-12-09"
rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)

library(tidyverse)
library(lubridate)
library(ggplot2)
library(dplyr)
library(readxl)
library(sf)
library(leaflet)
library(openxlsx)
library(readxl)
```
The goal of this markdown is to clean up the location names from Feather River redd survey data.

Summary of work that has been done so far:

  * redd_qc_2014-2023 - mainly exploratory: 
    *  raw data is pulled in, negative velocity values are set to NA
    * pot_depth_m >= 40 is set to NA
    * "type" is removed
    
  * mapping_qc: looks into latitude longitude and identifies issues. 
    * Data file input: "data/archive/all_redd_data.csv" 
  * clean_locations: fixed latitude/longitude provided by Chris Cook, these changes address the issues found on mapping_qc. 
    * Data file input: "data/archive/all_redd_data.csv". 
    * Data file output(s): "data-raw/redd_observations_clean_locations.csv" and "data/redd_observations.csv" (`location`, `survey_wk` and `file_number` removed)
  
```{r, include=FALSE}
redd_observations <- read.csv("data-raw/redd_observations_clean_locations.csv")
```

Looking into unique location names

  * There are 81 unique names
  
```{r}
unique(redd_observations$location)
```

```{r, include=FALSE}
# removing spaces
redd_observations$location <- gsub(" ", "", redd_observations$location)

# Display the modified vector
print(unique(redd_observations$location))

```


Survey location names - redd data  locations will be matched to these names

```{r, echo=FALSE, message=FALSE}
# Names from survey location provided by Chris Cook
reference_locations <- c(
  "UpperHatchery", "UpperCottonwood", "Hatchery", "Cottonwood",
  "TopofAuditorium", "MoesSideChannel", "UpperAuditorium", "MiddleAuditorium",
  "LowerAuditorium", "HatcheryPipe", "LowerTableMountain", "TableMountain",
  "BelowLowerAuditorium", "Bedrock", "TrailerPark", "UpperMathews",
  "Mathews", "UpperRobinson", "LowerRobinson", "Steep",
  "SteepSideChannel", "Weir", "Eye", "EyeSideChannel",
  "Gateway", "Aleck", "HatcherySideChannel", "VanceEast",
  "VanceWest", "BigHoleEast", "BigHoleWest", "BelowBigHoleEast",
  "G95WestSideChannel", "G95EastSideChannelTop", "G95EastSideChannelBottom", "UpperHour",
  "LowerHour", "Keister", "Goose", "Big",
  "LowerBig", "BigBar", "UpperMcFarland", "LowerMcFarland",
  "Developing"
)

reference_locations <- tolower(reference_locations)
table_data <- data.frame(
  ID = seq_along(reference_locations), 
  Name = reference_locations
)
table_data <- table_data[order(table_data$Name), ]

# Generate the sorted table
knitr::kable(table_data, col.names = c("ID", "Location Name"))
```

Identifying locations that do not match survey location names

```{r, echo=FALSE}
invalid_locations <- redd_observations$location[!redd_observations$location %in% reference_locations]

# Display invalid locations
unique_invalid_locations <- unique(invalid_locations)
print(unique_invalid_locations)
```

```{r, include=FALSE}
# renaming those that are just miss spelled 
redd_observations_clean_1 <- redd_observations |> 
  mutate(location = case_when(
    location == "aleckriffle" ~ "aleck",
    location == "bedrockriffle" ~ "bedrock",
    location == "bigriffle" | location ==	"bigbarriffle" ~	"bigbar",
    location == "g-95eastsidechannelbottom"	| location == "g95eastbottom"	~ "g95eastsidechannelbottom",
    location == "g-95easttop" | location == "g95easttop"	~ "g95eastsidechanneltop",
    location == "g-95westsidechannelbottom" | location ==	"g95west" | location ==	"g95westbottom" ~	"g95westsidechannel",
    location == "gooseriffle"	~	"goose",
    location == "hatcheryriffle" ~ "hatchery", # unsure relationship
    location == "hatcherysidechannelupper" ~	"hatcherysidechannel",
    location == "lowerbigriffle" ~	"lowerbig",
    location == "matthews" ~	"mathews",
    location == "midauditorium"| location == "midhour" ~	"middleauditorium", # unsure about midhour relationship
    location == "moe'ssidechannel" ~ "moessidechannel",
    location == "steepriffle"	~	"steep", # unsure
    location == "steepside" ~ "steepsidechannel", #unsure
    location == "topofaudtorium" ~ "topofauditorium",
    location == "upperhatcheryriffle" ~	"upperhatchery",
    location == "uppermatthews" ~	"uppermathews",
    location == "weirriffle"	~	"weir",
    location == "developingriffle" ~ "developing",
    TRUE ~ location)) 

print(unique(redd_observations_clean_1$location))
```

Current unique redd location naems that do not match survey locations

```{r, echo=FALSE}
# checking for the locations that still dont match reference names, after cleaning above
print(unique(redd_observations_clean_1$location[!redd_observations_clean_1$location %in% reference_locations]))
```


```{r, include=FALSE}
names_for_check <- redd_observations_clean_1 |> 
   filter(!location %in% reference_locations)  # Keep only the rows with inconsistent location names
# not_consistent_names <- st_as_sf(not_consistent_names, coords = c("longitude", "latitude"), crs = 4326)
```

Reference map to check where redds are located geographically

```{r, echo=FALSE}
# pulling layers from survey location map for reference
gdb_path <- "data-raw/shapefiles/b105_redd_survey_locations_maps_2021.gdb"
layers <- st_layers(gdb_path)$name

name_check_map <- leaflet() |> 
  addTiles() |> 
  setView(lng = -121.5695, lat = 39.3665, zoom = 10)

for (layer_name in layers) {
  shapefile <- st_read(dsn = gdb_path, layer = layer_name)
  shapefile <- st_transform(shapefile, crs = 4326) |> 
    st_zm(drop = TRUE, what = "ZM")
  
name_check_map <- name_check_map |> 
    addPolygons(
      data = shapefile,
      fillColor = "lightblue",  
      color = "darkblue",
      weight = 2,               
      opacity = 1.0,            
      fillOpacity = 0.5,        
      group = layer_name,
      popup = paste("Layer Name: ", layer_name)
    )
}

locations <- unique(names_for_check$location)
name_check_map <- name_check_map |> 
  addCircleMarkers(data = names_for_check, 
                   ~longitude, ~latitude, 
                   label = ~paste(location),
                   popup = ~paste("Location:", location, "<br>Date:", date, "<br>Latitude:", latitude, "<br>Longitude:",
                                  longitude, "<br>Survey Week:", survey_wk),
                   group = ~location,
                   radius = 2,  
                   color = "red")

name_check_map <- name_check_map |> 
  addLayersControl(
    overlayGroups = c(locations), # Add chek boxes for the location names 
    options = layersControlOptions(collapsed = FALSE)
  )

# Display the map
name_check_map
```

Notes / observations form map:

  * hour: most points are located near "LowerHour", however two are withing "UpperHour"
  * palm / palmriffle are not within any survey location - it was not modified
  * g95main / g-95main: points are located between G95EastSideChannelTop and G95WestSideChannel, however there is no survey location there. There are two 95main points that are off
  * lowervanceeast: 3 points are within "BigHoleEast" (these were modified to BigHoleEast), all others are off any survey location - south of "VanceEast", north of "BigHoleEast"
  * greatwestern: do not fall within and survey locations - no changes made
  * topofhatchery: do not fall within and survey locations - no changes made
  * gatewaymainchannel: located on survey location Gateway, modified
  * upperbigholeeast: modified to BigHoleEast
  * moe'sditch: modified 
  
Modifications - all points that fall withing a survey location will be modified to match to that name

```{r, include=FALSE}
redd_observations_clean_2 <- redd_observations_clean_1 |>
  mutate(location = case_when(
     location == "hour" & date == "2015-11-19" & latitude == "39.4225537735696" & longitude == "-121.624800693264" ~ "upperhour",
     location == "hour" & date == "2015-11-19" & latitude == "39.4224821992187" & longitude == "-121.624878645819" ~ "upperhour",
     location == "hour" ~ "lowerhour",
     location == "upperhoureast" & date == "2014-10-09" & latitude == "39.4166671193809" & longitude == "-121.627212180498"
    ~ "lowerhour",
    location == "upperhoureast" & date == "2014-10-09" & latitude == "39.4159674094301" & longitude == "-121.627254551989" 
    ~ "lowerhour",
    location == "developingriffle" ~ "developing",
    location == "moe'sditch" & !(latitude == "39.5156950186919" & longitude == "-121.559350861003") ~ "moessidechannel",
    location == "moe'sditch" & latitude == "39.5156950186919" & longitude == "-121.559350861003" ~ "middleauditorium",
    location == "lowervanceeast" & date == "2017-11-14" & latitude == "39.439059494603" & longitude == "-121.635427259305" ~ "bigholeeast",
    location == "lowervanceeast" & date == "2017-11-14" & latitude == "39.4388562088935" & longitude == "-121.635448923638" ~ "bigholeeast",
    location == "lowervanceeast" & date == "2017-11-14" & latitude == "39.4388504794907" & longitude == "-121.635372994652" ~ "bigholeeast",
    location == "gatewaysidechannel" | location == "gatewaymainchannel" ~ "gateway",
    location == "upperbigholeeast" ~ "bigholeeast",
    TRUE ~ location
  ))

print(unique(redd_observations_clean_2$location))

print(unique(redd_observations_clean_2$location[!redd_observations_clean_2$location %in% reference_locations]))
```

Listing names that ramain unmatched to any suervey locations

```{r, echo=FALSE}
names_for_check_2 <- redd_observations_clean_2 |> 
   filter(!location %in% reference_locations)
```

```{r, echo=FALSE}

name_check_map_2 <- leaflet() |> 
  addTiles() |> 
  setView(lng = -121.5695, lat = 39.3665, zoom = 10)

for (layer_name in layers) {
  shapefile <- st_read(dsn = gdb_path, layer = layer_name)
  shapefile <- st_transform(shapefile, crs = 4326) |> 
    st_zm(drop = TRUE, what = "ZM")
  
name_check_map_2 <- name_check_map_2 |> 
    addPolygons(
      data = shapefile,
      fillColor = "lightblue",  
      color = "darkblue",
      weight = 2,               
      opacity = 1.0,            
      fillOpacity = 0.5,        
      group = layer_name,
      popup = paste("Layer Name: ", layer_name)
    )
}

locations <- unique(names_for_check_2$location)
name_check_map_2 <- name_check_map_2 |> 
  addCircleMarkers(data = names_for_check_2, 
                   ~longitude, ~latitude, 
                   label = ~paste(location),
                   popup = ~paste("Location:", location, "<br>Date:", date, "<br>Latitude:", latitude, "<br>Longitude:",
                                  longitude, "<br>Survey Week:", survey_wk),
                   group = ~location,
                   radius = 2,  
                   color = "red")

name_check_map_2 <- name_check_map_2 |> 
  addLayersControl(
    overlayGroups = c(locations), # Add chek boxes for the location names 
    options = layersControlOptions(collapsed = FALSE)
  )

# Display the map
name_check_map_2
```

```{r}

redd_observations_wnames <- redd_observations_clean_2 |> 
  select(-file_number) |> # keeping survey week and location
  glimpse()
# save clean data
write.csv(redd_observations_clean_2, "data/redd_observations_wnames.csv", row.names = FALSE)

```

